name: CI

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: "stable"

    - name: Set up build environment (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake

    - name: Set up build environment (macOS)
      if: startsWith(matrix.os, 'macos')
      run: |
        brew install cmake

    - name: Install MinGW-w64 and CMake (Windows)
      if: matrix.os == 'windows-latest'
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          make

    - name: Get llama.cpp commit
      id: get_commit
      shell: bash
      run: |
        LLAMA_COMMIT=$(git submodule status core/llama.cpp | awk '{print $1}' | sed 's/^-//')
        echo "llama_commit=${LLAMA_COMMIT}" >> $GITHUB_OUTPUT
        echo "Llama.cpp commit: ${LLAMA_COMMIT}"

    - name: Download dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Build C++ library (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        ./scripts/build.sh

    - name: Build C++ library (Windows)
      if: runner.os == 'Windows'
      shell: msys2 {0}
      run: |
        export CC=gcc
        export CXX=g++
        bash ./scripts/build.sh

    - name: Verify C++ build
      shell: bash
      run: |
        echo "Checking C++ build output:"
        ls -la build/bin/ || ls -la build\bin\ || true
        echo "Checking library files:"
        find core -name "*.a" || true
        if [ -f "core/llama.cpp/.patch_applied" ]; then
          echo "✓ Patches applied successfully"
        else
          echo "✗ Patches not applied"
          exit 1
        fi

    - name: Build Go wrapper (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        go mod tidy
        go build -v ./wrapper

    - name: Build Go wrapper (Windows)
      if: runner.os == 'Windows'
      shell: msys2 {0}
      run: |
        export CC=gcc
        export CXX=g++
        go mod tidy
        go build -v ./wrapper

    - name: Build modelembed sample (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        go build -v -o build/bin/modelembed ./cmd/modelembed

    - name: Build modelembed sample (Windows)
      if: runner.os == 'Windows'
      shell: msys2 {0}
      run: |
        export CC=gcc
        export CXX=g++
        go build -v -o build/bin/modelembed.exe ./cmd/modelembed

    - name: Verify Go builds
      shell: bash
      run: |
        echo "Checking Go build outputs:"
        ls -la build/bin/
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          if [ ! -f build/bin/modelembed.exe ]; then
            echo "Error: modelembed.exe not found"
            exit 1
          fi
          echo "✓ modelembed.exe built successfully"
        else
          if [ ! -f build/bin/modelembed ]; then
            echo "Error: modelembed not found"
            exit 1
          fi
          echo "✓ modelembed built successfully"
        fi

    - uses: golangci/golangci-lint-action@v7
      with:
        version: v2.0
        skip-cache: true
        args: --enable-only=govet --tests=false ./...

    - name: Run tests (Ubuntu with coverage)
      if: matrix.os == 'ubuntu-latest'
      run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./... || echo "No tests or tests failed"

    - name: Run tests (macOS)
      if: startsWith(matrix.os, 'macos')
      run: go test -v ./... || echo "No tests or tests failed"

    - name: Run tests (Windows)
      if: matrix.os == 'windows-latest'
      shell: msys2 {0}
      run: |
        export CC=gcc
        export CXX=g++
        go test -v ./... || echo "No tests or tests failed"

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.txt
        fail_ci_if_error: false
